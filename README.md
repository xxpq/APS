# Proxy Tool - é«˜çº§ HTTP/HTTPS ä»£ç†å·¥å…·

ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„ã€å¯é…ç½®çš„ HTTP/HTTPS ä»£ç†å·¥å…·ï¼Œæ”¯æŒ URL é‡æ˜ å°„ã€è¯·æ±‚/å“åº”ä¿®æ”¹ã€è®¤è¯ã€æ¨¡å—åŒ–ä»£ç†æ± ã€åŠ¨æ€ HAR æ—¥å¿—è®°å½•ç­‰é«˜çº§åŠŸèƒ½ã€‚

## âœ¨ æ ¸å¿ƒç‰¹æ€§

- **ğŸ”„ åŒå‘æ•°æ®å¤„ç†**ï¼šä¿®æ”¹è¯·æ±‚/å“åº”çš„ Headers å’Œ Bodyï¼Œæ”¯æŒæ­£åˆ™åŒ¹é…å’Œæ›¿æ¢ã€‚
- **ğŸ” ç»Ÿä¸€å®‰å…¨æ¨¡å‹**ï¼š
  - **ç”¨æˆ·/ç»„è®¤è¯**ï¼šå¯åœ¨æœåŠ¡å™¨æˆ–å•æ¡è§„åˆ™ä¸Šå¼ºåˆ¶æ‰§è¡Œ `Proxy-Authorization` è®¤è¯ã€‚
  - **è‡ªåŠ¨ HTTPS è¯ä¹¦**ï¼šä¸ºæ‰€æœ‰æœåŠ¡å™¨è‡ªåŠ¨ç”Ÿæˆå’Œç®¡ç† TLS è¯ä¹¦ã€‚
- **modular é…ç½®**ï¼š
  - **å‘½åæœåŠ¡å™¨ (`servers`)**ï¼šå®šä¹‰å¤šä¸ªå¯å¤ç”¨çš„ç›‘å¬ç«¯å£ï¼Œæ¯ä¸ªç«¯å£éƒ½æ˜¯åŠŸèƒ½å®Œæ•´çš„ä»£ç†æœåŠ¡å™¨ã€‚
  - **å‘½åä»£ç†æ±  (`proxies`)**ï¼šåˆ›å»ºå¯å¤ç”¨çš„ä¸Šæ¸¸ä»£ç†æœåŠ¡å™¨ç»„ï¼Œæ”¯æŒéšæœºè´Ÿè½½å‡è¡¡ã€‚
- **ğŸ¯ çµæ´»çš„ URL æ˜ å°„**ï¼š
  - å­—ç¬¦ä¸²ï¼ˆæ”¯æŒ `*` é€šé…ç¬¦ï¼‰å’Œæ­£åˆ™è¡¨è¾¾å¼åŒ¹é…ã€‚
  - å°†è§„åˆ™åŠ¨æ€ç»‘å®šåˆ°ä¸€ä¸ªæˆ–å¤šä¸ª `servers`ã€‚
  - ä¸ºè§„åˆ™ç»‘å®šä¸€ä¸ªæˆ–å¤šä¸ª `proxies` ä»£ç†æ± ã€‚
- **ğŸ“Š åŠ¨æ€è°ƒè¯•ä¸ç›‘æ§**ï¼š
  - **æŒ‰éœ€ HAR æ—¥å¿—**ï¼šå¯åœ¨ `server`ã€`mapping`ã€`user` æˆ– `group` çº§åˆ«ä¸Šå¯ç”¨ HAR æ—¥å¿—è®°å½•ã€‚
  - **é…ç½®çƒ­é‡è½½**ï¼šä¿®æ”¹é…ç½®æ–‡ä»¶åè‡ªåŠ¨åº”ç”¨æ–°è§„åˆ™ï¼Œæ— éœ€é‡å¯ã€‚
  - **Carbon Copy (`cc`)**ï¼šå°†è¯·æ±‚å®æ—¶å¤åˆ¶åˆ°å…¶ä»–ç«¯ç‚¹ã€‚

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…

```bash
# ç¼–è¯‘
go build -o proxy_tool.exe .
```

### 2. åˆ›å»ºé…ç½®æ–‡ä»¶ `config.json`

è¿™æ˜¯æ–°æ¶æ„ä¸‹çš„ä¸€ä¸ªåŸºæœ¬ç¤ºä¾‹ï¼Œå®ƒå®šä¹‰äº†ä¸€ä¸ªç›‘å¬ `8080` ç«¯å£çš„æœåŠ¡å™¨å’Œä¸€ä¸ªç®€å•çš„ URL æ˜ å°„è§„åˆ™ã€‚

```json
{
  "servers": {
    "main": {
      "port": 8080,
      "cert": "auto"
    }
  },
  "mappings": [
    {
      "from": "https://api.example.com/*",
      "to": "https://backend.example.com/*",
      "listen": ["main"]
    }
  ]
}
```

### 3. å¯åŠ¨ä»£ç†

```bash
./proxy_tool.exe -config=config.json
```

### 4. é…ç½®ç³»ç»Ÿ/æµè§ˆå™¨ä»£ç†

å°†ä½ çš„æ“ä½œç³»ç»Ÿæˆ–æµè§ˆå™¨çš„ HTTP å’Œ HTTPS ä»£ç†è®¾ç½®ä¸º `127.0.0.1:8080`ã€‚

### 5. ä¸‹è½½å¹¶ä¿¡ä»»æ ¹è¯ä¹¦

ä¸ºäº†è®© HTTPS ä»£ç†æ­£å¸¸å·¥ä½œï¼Œä½ éœ€è¦ä¿¡ä»»æœ¬å·¥å…·çš„æ ¹è¯ä¹¦ã€‚å¯åŠ¨å·¥å…·åï¼Œé€šè¿‡**ä»»æ„å·²é…ç½®çš„ä»£ç†ç«¯å£**è®¿é—® `/.ssl/cert.der` å³å¯ä¸‹è½½ã€‚

ä¾‹å¦‚ï¼Œè®¿é—® `http://127.0.0.1:8080/.ssl/cert.der`ï¼Œç„¶åå°†ä¸‹è½½çš„ `cert.der` æ–‡ä»¶å¯¼å…¥ç³»ç»Ÿçš„â€œå—ä¿¡ä»»çš„æ ¹è¯ä¹¦é¢å‘æœºæ„â€ä¸­ã€‚

## ğŸ“– é…ç½®è¯¦è§£

### é¡¶å±‚ç»“æ„

æ–°çš„é…ç½®ç»“æ„æ˜¯å®Œå…¨æ¨¡å—åŒ–çš„ï¼Œç”±å››ä¸ªæ ¸å¿ƒçš„é¡¶å±‚éƒ¨åˆ†ç»„æˆï¼š`servers`ã€`proxies`ã€`auth` å’Œ `mappings`ã€‚

```json
{
  "servers": {
    "server_name_1": { ... },
    "server_name_2": { ... }
  },
  "proxies": {
    "proxy_group_1": [ ... ],
    "proxy_group_2": [ ... ]
  },
  "auth": {
    "users": { ... },
    "groups": { ... }
  },
  "p12s": {
    "cert_name_1": { ... }
  },
  "mappings": [
    { ... },
    { ... }
  ]
}
```

---

### 1. `servers` - å®šä¹‰ç›‘å¬æœåŠ¡

`servers` æ˜¯ä¸€ä¸ª `map`ï¼Œç”¨äºå®šä¹‰ä¸€ä¸ªæˆ–å¤šä¸ªå‘½åçš„ç›‘å¬æœåŠ¡å™¨ã€‚**æ¯ä¸ªå®šä¹‰çš„ server éƒ½æ˜¯ä¸€ä¸ªåŠŸèƒ½å®Œæ•´çš„ä»£ç†**ï¼Œå¯ä»¥å¤„ç†æ‰€æœ‰ç±»å‹çš„æµé‡ï¼ˆæ™®é€šä»£ç†ã€URL æ˜ å°„ã€è¯ä¹¦ä¸‹è½½ï¼‰ã€‚

```json
{
  "servers": {
    "main_proxy": {
      "port": 8080,
      "cert": "auto",
      "auth": { "required": true },
      "dump": "./logs/main_proxy.har"
    },
    "dev_server": {
      "port": 3000,
      "cert": {
        "cert": "./.cert/dev.crt",
        "key": "./.cert/dev.key"
      }
    }
  }
}
```

**å­—æ®µè¯´æ˜**ï¼š

- `port` (å¿…éœ€): ç›‘å¬çš„ç«¯å£ã€‚
- `cert` (å¯é€‰): è¯ä¹¦é…ç½®ã€‚
  - `"auto"`: è‡ªåŠ¨ç”Ÿæˆå’Œç®¡ç†è¯ä¹¦ã€‚
  - `object`: æŒ‡å®šè‡ªå®šä¹‰è¯ä¹¦æ–‡ä»¶çš„è·¯å¾„ã€‚
- `auth` (å¯é€‰): ä¸ºæ­¤æœåŠ¡å™¨å¯ç”¨å…¨å±€è®¤è¯ã€‚è¯¦æƒ…è§ `auth` éƒ¨åˆ†ã€‚
- `dump` (å¯é€‰): ä¸ºæ‰€æœ‰é€šè¿‡æ­¤æœåŠ¡å™¨çš„æµé‡å¯ç”¨ HAR æ—¥å¿—è®°å½•ï¼ˆé™¤éè¢«æ›´å…·ä½“çš„è§„åˆ™è¦†ç›–ï¼‰ã€‚
- **è¿æ¥ç­–ç•¥**: `timeout`, `idleTimeout`, `maxThread`, `quality` (è¯¦æƒ…è§ä¸‹æ–‡)ã€‚

---

### 2. `proxies` - å®šä¹‰ä¸Šæ¸¸ä»£ç†æ± 

`proxies` æ˜¯ä¸€ä¸ª `map`ï¼Œç”¨äºå®šä¹‰å¯å¤ç”¨çš„ä¸Šæ¸¸ä»£ç†æœåŠ¡å™¨ç»„ã€‚å½“ä¸€ä¸ª `mapping` è§„åˆ™éœ€è¦é€šè¿‡ä¸Šæ¸¸ä»£ç†è®¿é—®æ—¶ï¼Œå¯ä»¥å¼•ç”¨è¿™é‡Œçš„é…ç½®ã€‚

```json
{
  "proxies": {
    "us_proxies": [
      "http://user:pass@us-proxy1.com:8080",
      "http://user:pass@us-proxy2.com:8080"
    ],
    "jp_proxies": [
      "socks5://jp-proxy1.com:1080"
    ],
    "dynamic_proxies": "https://proxy-provider.com/list.txt"
  }
}
```

**åŠŸèƒ½è¯´æ˜**ï¼š

- **å‘½åä¸å¤ç”¨**ï¼šæ–¹ä¾¿åœ°åœ¨å¤šä¸ª `mapping` è§„åˆ™ä¸­å…±äº«å’Œç®¡ç†ä»£ç†é…ç½®ã€‚
- **è´Ÿè½½å‡è¡¡**ï¼šå¦‚æœä¸€ä¸ªç»„å†…æœ‰å¤šä¸ªä»£ç†åœ°å€ï¼Œæ¯æ¬¡è¯·æ±‚ä¼š**éšæœºé€‰æ‹©ä¸€ä¸ª**ä½¿ç”¨ã€‚
- **å¤šç§æºæ ¼å¼**ï¼š
  - **æ•°ç»„**ï¼šç›´æ¥åœ¨ JSON ä¸­å®šä¹‰ä»£ç†åˆ—è¡¨ã€‚
  - **æœ¬åœ°æ–‡ä»¶**ï¼šæä¾›ä¸€ä¸ªæ–‡ä»¶è·¯å¾„ï¼Œå¦‚ `"./proxies.txt"`ã€‚
  - **è¿œç¨‹ URL**ï¼šæä¾›ä¸€ä¸ª URLï¼Œä»£ç†å·¥å…·ä¼šå®šæœŸï¼ˆæ¯5åˆ†é’Ÿï¼‰æ‹‰å–æ›´æ–°ã€‚

---

### 3. `auth` - å®šä¹‰ç”¨æˆ·å’Œç»„

`auth` å—ç”¨äºå®šä¹‰ç”¨æˆ·ã€å¯†ç å’Œç”¨æˆ·ç»„ï¼Œæ˜¯å®ç°è®¤è¯åŠŸèƒ½çš„åŸºç¡€ã€‚

```json
{
  "auth": {
    "users": {
      "admin": {
        "password": "a_strong_password",
        "groups": ["admins", "developers"],
        "dump": "./logs/users/admin.har"
      },
      "guest": {
        "password": "guest_password"
      }
    },
    "groups": {
      "developers": {
        "comment": "Can access staging APIs",
        "dump": "./logs/groups/dev.har"
      },
      "admins": {
        "comment": "Full access"
      }
    }
  }
}
```

**å­—æ®µè¯´æ˜**ï¼š

- `users`: å®šä¹‰ç”¨æˆ·åå’Œå¯¹åº”çš„ `password`ã€`groups`ã€`dump` ä»¥åŠè¿æ¥ç­–ç•¥ã€‚
- `groups`: å®šä¹‰ç”¨æˆ·ç»„ï¼Œå¯ä»¥å…³è” `dump` é…ç½®å’Œè¿æ¥ç­–ç•¥ã€‚

è®¤è¯é€šè¿‡ `Proxy-Authorization` HTTP Header å®ç°ï¼Œé‡‡ç”¨ `Basic` è®¤è¯æ–¹æ¡ˆã€‚

---

### 4. `p12s` - å®šä¹‰å®¢æˆ·ç«¯è¯ä¹¦

`p12s` æ˜¯ä¸€ä¸ª `map`ï¼Œç”¨äºæ³¨å†Œå’Œå‘½åå®¢æˆ·ç«¯è¯ä¹¦ï¼ˆ.p12 æˆ– .pfx æ–‡ä»¶ï¼‰ï¼Œä»¥ä¾¿åœ¨ `mapping` è§„åˆ™ä¸­å¼•ç”¨ä»¥å®ç°åŒå‘è®¤è¯ (mTLS)ã€‚

```json
{
  "p12s": {
    "my_client_cert": {
      "path": "./certs/client.p12",
      "password": "p12_password"
    }
  }
}
```

**å­—æ®µè¯´æ˜**:
- `path` (å¿…éœ€): `.p12` æˆ– `.pfx` è¯ä¹¦æ–‡ä»¶çš„è·¯å¾„ã€‚
- `password` (å¿…éœ€): è¯ä¹¦æ–‡ä»¶çš„å¯†ç ã€‚

---

### 5. `mappings` - å®šä¹‰è·¯ç”±å’Œå¤„ç†è§„åˆ™

`mappings` æ˜¯ä¸€ä¸ªè§„åˆ™æ•°ç»„ï¼Œæ˜¯å·¥å…·çš„æ ¸å¿ƒã€‚æ¯æ¡è§„åˆ™å®šä¹‰äº†å¦‚ä½•åŒ¹é…è¯·æ±‚ï¼Œå¹¶å¦‚ä½•å¤„ç†å®ƒã€‚

```json
{
  "from": "string | object",
  "to": "string | object",
  "local": "string (optional)",
  "listen": ["string array (optional)"],
  "proxy": ["string array (optional)"],
  "p12": "string (optional)",
  "auth": { ... },
  "dump": "string (optional)",
  "cc": ["string array (optional)"]
}
```

**æ ¸å¿ƒå…³è”å­—æ®µ**ï¼š

- `listen` (å¯é€‰): ä¸€ä¸ªå­—ç¬¦ä¸²æ•°ç»„ï¼ŒæŒ‡å®šè¿™æ¡è§„åˆ™åœ¨å“ªäº› `servers` ä¸Šç”Ÿæ•ˆã€‚
  - å¦‚æœ `from` æ˜¯**ç»å¯¹ URL** (e.g., `https://...`)ï¼Œè§„åˆ™åœ¨é€šè¿‡æŒ‡å®š `server` ä»£ç†æ—¶ç”Ÿæ•ˆã€‚
  - å¦‚æœ `from` æ˜¯**ç›¸å¯¹ URL** (e.g., `/api/*`)ï¼Œè§„åˆ™åœ¨ç›´æ¥è®¿é—®æŒ‡å®š `server` æ—¶ç”Ÿæ•ˆã€‚
  - **å¦‚æœä¸æä¾› `listen`**ï¼Œè§„åˆ™é»˜è®¤åœ¨**æ‰€æœ‰**å®šä¹‰çš„ `servers` ä¸Šç”Ÿæ•ˆã€‚
- `proxy` (å¯é€‰): ä¸€ä¸ªå­—ç¬¦ä¸²æ•°ç»„ï¼ŒæŒ‡å®šè¯·æ±‚åŒ¹é…åï¼Œä½¿ç”¨å“ªäº›åœ¨ `proxies` ä¸­å®šä¹‰çš„ä»£ç†æ± ã€‚æ¯æ¬¡è¯·æ±‚ä¼šä»æ‰€æœ‰æŒ‡å®šçš„ä»£ç†æ± ä¸­éšæœºé€‰æ‹©ä¸€ä¸ªä»£ç†åœ°å€ã€‚
- `p12` (å¯é€‰): ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå¼•ç”¨åœ¨ `p12s` ä¸­å®šä¹‰çš„å®¢æˆ·ç«¯è¯ä¹¦åç§°ã€‚å¦‚æœæä¾›ï¼Œä»£ç†åœ¨è½¬å‘æ­¤è¯·æ±‚æ—¶ä¼šå¸¦ä¸Šè¯¥è¯ä¹¦ï¼Œç”¨äº mTLS è®¤è¯ã€‚
- `auth` (å¯é€‰): ä¸ºå•æ¡è§„åˆ™å®šä¹‰è®¤è¯è¦æ±‚ã€‚
  - `{"users": ["admin"], "groups": ["developers"]}`: å…è®¸ `admin` ç”¨æˆ·æˆ– `developers` ç»„çš„æˆå‘˜è®¿é—®ã€‚
  - `{"required": true}`: å…è®¸ä»»ä½•å·²å®šä¹‰çš„ç”¨æˆ·è®¿é—®ã€‚
- `dump` (å¯é€‰): ä¸ºåŒ¹é…æ­¤è§„åˆ™çš„æµé‡å¯ç”¨ HAR æ—¥å¿—ï¼Œ**ä¼˜å…ˆçº§æœ€é«˜**ã€‚
- **è¿æ¥ç­–ç•¥**: `timeout`, `idleTimeout`, `maxThread`, `quality` (è¯¦æƒ…è§ä¸‹æ–‡)ã€‚

### `from` å’Œ `to` çš„è¯¦ç»†é…ç½®

`from` å’Œ `to` å¯¹è±¡å†…éƒ¨çš„é…ç½®ä¿æŒä¸å˜ï¼Œæ”¯æŒ `url`, `headers`, `querystring`, `match`, `replace` ç­‰ã€‚

---

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹ 1: åŸºç¡€è®¾ç½® - å¤šæœåŠ¡å™¨ä¸è§„åˆ™ç»‘å®š

å®šä¹‰ä¸€ä¸ªå…¬å…±ä»£ç†å’Œä¸€ä¸ªå†…éƒ¨å¼€å‘æœåŠ¡å™¨ï¼Œå¹¶å°†ä¸åŒçš„è§„åˆ™ç»‘å®šåˆ°å®ƒä»¬ä¸Šé¢ã€‚

```json
{
  "servers": {
    "public_proxy": { "port": 8080, "cert": "auto" },
    "dev_server": { "port": 3000 }
  },
  "mappings": [
    {
      "comment": "è§„åˆ™1: ä»…åœ¨å…¬å…±ä»£ç†ä¸Šç”Ÿæ•ˆ",
      "from": "https://api.openai.com/*",
      "to": "https://api.openai.com/*",
      "listen": ["public_proxy"]
    },
    {
      "comment": "è§„åˆ™2: æ‰˜ç®¡æœ¬åœ°æ–‡ä»¶ï¼Œä»…åœ¨å¼€å‘æœåŠ¡å™¨ä¸Šç”Ÿæ•ˆ",
      "from": "/static/*",
      "local": "./static/*",
      "listen": ["dev_server"]
    },
    {
      "comment": "è§„åˆ™3: åœ¨ä¸¤ä¸ªæœåŠ¡å™¨ä¸Šéƒ½ç”Ÿæ•ˆ",
      "from": "https://api.google.com/*",
      "to": "https://api.google.com/*",
      "listen": ["public_proxy", "dev_server"]
    }
  ]
}
```

**è®¿é—®æ–¹å¼**ï¼š

- æµè§ˆå™¨ä»£ç†è®¾ä¸º `127.0.0.1:8080`ï¼Œè®¿é—® `https://api.openai.com` ä¼šè§¦å‘è§„åˆ™1ã€‚
- ç›´æ¥è®¿é—® `http://localhost:3000/static/app.js` ä¼šè§¦å‘è§„åˆ™2ã€‚
- æ— è®ºä½¿ç”¨å“ªä¸ªä»£ç†ï¼Œè®¿é—® `https://api.google.com` éƒ½ä¼šè§¦å‘è§„åˆ™3ã€‚

### ç¤ºä¾‹ 2: ä½¿ç”¨å‘½åä»£ç†æ± 

å®šä¹‰å¯å¤ç”¨çš„ä»£ç†æ± ï¼Œå¹¶åœ¨è§„åˆ™ä¸­æŒ‰éœ€ä½¿ç”¨ã€‚

```json
{
  "servers": { "main": { "port": 8080, "cert": "auto" } },
  "proxies": {
    "us_pool": [
      "http://proxy1.us.com:8080",
      "http://proxy2.us.com:8080"
    ],
    "eu_pool": [
      "http://proxy1.eu.com:8080"
    ]
  },
  "mappings": [
    {
      "comment": "è®¿é—® Anthropic API æ—¶ï¼Œä½¿ç”¨ç¾å›½ä»£ç†æ± ",
      "from": "https://api.anthropic.com/*",
      "to": "https://api.anthropic.com/*",
      "proxy": ["us_pool"]
    },
    {
      "comment": "è®¿é—® Google API æ—¶ï¼Œä»ç¾å›½æˆ–æ¬§æ´²ä»£ç†æ± ä¸­éšæœºé€‰æ‹©",
      "from": "https://api.google.com/*",
      "to": "https://api.google.com/*",
      "proxy": ["us_pool", "eu_pool"]
    }
  ]
}
```

### ç¤ºä¾‹ 3: è®¤è¯ç³»ç»Ÿ

å®ç°ä¸€ä¸ªéœ€è¦è®¤è¯çš„æœåŠ¡å™¨ï¼Œå¹¶ä¸ºç‰¹å®šè§„åˆ™è®¾ç½®æ›´ç²¾ç»†çš„è®¿é—®æ§åˆ¶ã€‚

```json
{
  "servers": {
    "secure_proxy": {
      "port": 8443,
      "cert": "auto",
      "auth": { "required": true }
    }
  },
  "auth": {
    "users": {
      "admin": { "password": "admin_pass", "groups": ["admins"] },
      "dev": { "password": "dev_pass", "groups": ["developers"] }
    },
    "groups": {
      "admins": {},
      "developers": {}
    }
  },
  "mappings": [
    {
      "comment": "åªæœ‰ admin ç”¨æˆ·å¯ä»¥è®¿é—®è¿™ä¸ª API",
      "from": "https://admin.example.com/*",
      "to": "https://backend.example.com/admin/*",
      "auth": { "users": ["admin"] }
    },
    {
      "comment": "æ‰€æœ‰ç”¨æˆ·éƒ½å¯ä»¥è®¿é—®è¿™ä¸ª",
      "from": "https://general.example.com/*",
      "to": "https://backend.example.com/general/*"
    }
  ]
}
```

**æ•ˆæœ**ï¼š

- æ‰€æœ‰é€šè¿‡ `8443` ç«¯å£çš„è¯·æ±‚éƒ½å¿…é¡»æä¾›æœ‰æ•ˆçš„ç”¨æˆ·åå’Œå¯†ç ã€‚
- å³ä½¿ `dev` ç”¨æˆ·é€šè¿‡äº†æœåŠ¡å™¨è®¤è¯ï¼Œä»–ä¹Ÿæ— æ³•è®¿é—® `https://admin.example.com`ï¼Œå› ä¸ºè§„åˆ™çº§åˆ«æœ‰æ›´ä¸¥æ ¼çš„é™åˆ¶ã€‚

### ç¤ºä¾‹ 4: åŠ¨æ€ HAR æ—¥å¿—è®°å½•

æ ¹æ®ä¸åŒçš„ç»´åº¦ï¼ˆæœåŠ¡å™¨ã€ç”¨æˆ·ã€è§„åˆ™ï¼‰è®°å½• HAR æ—¥å¿—ã€‚

```json
{
  "servers": {
    "main": {
      "port": 8080,
      "cert": "auto",
      "dump": "./logs/default.har"
    }
  },
  "auth": {
    "users": {
      "inspector": {
        "password": "a_password",
        "dump": "./logs/inspector_user.har"
      }
    }
  },
  "mappings": [
    {
      "comment": "è¿™æ˜¯ä¸€ä¸ªéœ€è¦é‡ç‚¹ç›‘æ§çš„ APIï¼Œå•ç‹¬è®°å½•",
      "from": "https://critical.api.com/*",
      "to": "https://backend.critical.com/*",
      "dump": "./logs/critical_api.har"
    }
  ]
}
```

**HAR æ–‡ä»¶é€‰æ‹©ä¼˜å…ˆçº§** (ä»é«˜åˆ°ä½):

1. `mapping.dump`
2. `user.dump`
3. `group.dump`
4. `server.dump`

**åœºæ™¯åˆ†æ**ï¼š

- `inspector` ç”¨æˆ·è®¿é—® `https://critical.api.com` -> æ—¥å¿—å†™å…¥ `critical_api.har` (Mapping ä¼˜å…ˆçº§æœ€é«˜)ã€‚
- `inspector` ç”¨æˆ·è®¿é—®å…¶ä»–ç½‘ç«™ -> æ—¥å¿—å†™å…¥ `inspector_user.har` (User ä¼˜å…ˆçº§æ¬¡ä¹‹)ã€‚
- å…¶ä»–åŒ¿åç”¨æˆ·è®¿é—®ä»»ä½•ç½‘ç«™ (é™¤äº† critical.api.com) -> æ—¥å¿—å†™å…¥ `default.har` (Server ä¼˜å…ˆçº§æœ€ä½)ã€‚

---

### ç¤ºä¾‹ 5: è¿æ¥æ§åˆ¶ä¸å¼±ç½‘æ¨¡æ‹Ÿ

ä½ å¯ä»¥é€šè¿‡åœ¨ `server`, `mapping`, `group`, æˆ– `user` çº§åˆ«ä¸Šè®¾ç½®è¿æ¥ç­–ç•¥æ¥ç²¾ç»†åŒ–æ§åˆ¶è¯·æ±‚è¡Œä¸ºã€‚

**ç­–ç•¥å­—æ®µ**:
- `timeout` (æ•´æ•°, ç§’): æ•´ä¸ªè¯·æ±‚çš„è¶…æ—¶æ—¶é—´ï¼Œä»å‘é€è¯·æ±‚åˆ°æ¥æ”¶å®Œå“åº”ã€‚é»˜è®¤ `600` (10åˆ†é’Ÿ)ã€‚
- `idleTimeout` (æ•´æ•°, ç§’): è¿æ¥ç©ºé—²è¶…æ—¶æ—¶é—´ã€‚é»˜è®¤ `100`ã€‚
- `maxThread` (æ•´æ•°): å¹¶å‘è¯·æ±‚æ•°é™åˆ¶ã€‚è¶…è¿‡é™åˆ¶çš„è¯·æ±‚å°†æ”¶åˆ° `429 Too Many Requests` é”™è¯¯ã€‚é»˜è®¤æ— é™åˆ¶ã€‚
- `quality` (æµ®ç‚¹æ•°, 0.0-1.0): æ¨¡æ‹Ÿç½‘ç»œè´¨é‡ã€‚`1.0` ä¸ºæ­£å¸¸é€Ÿåº¦ï¼Œ`0.5` ä¸º 50% çš„é€Ÿåº¦ã€‚è¿™ä¼šé€šè¿‡é™åˆ¶å“åº”ä½“çš„è¯»å–é€Ÿç‡æ¥å®ç°ã€‚

**ä¼˜å…ˆçº§**:
ç­–ç•¥åº”ç”¨çš„ä¼˜å…ˆçº§ä¸º `user` > `group` > `mapping` > `server`ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä¸€ä¸ª `user` å’Œä¸€ä¸ª `mapping` éƒ½å®šä¹‰äº† `timeout`ï¼Œå°†ä½¿ç”¨ `user` ä¸­å®šä¹‰çš„å€¼ã€‚

```json
{
  "servers": {
    "main": {
      "port": 8080,
      "cert": "auto",
      "maxThread": 100
    }
  },
  "auth": {
    "users": {
      "vip_user": {
        "password": "vip_password",
        "timeout": 120
      }
    }
  },
  "mappings": [
    {
      "comment": "å¯¹å¤§æ–‡ä»¶ä¸‹è½½è¿›è¡Œé™é€Ÿå¹¶è®¾ç½®æ›´é•¿çš„è¶…æ—¶",
      "from": "https://files.example.com/*",
      "to": "https://backend.files.com/*",
      "timeout": 1800,
      "quality": 0.2
    },
    {
      "comment": "æ™®é€š API è¯·æ±‚",
      "from": "https://api.example.com/*",
      "to": "https://backend.api.com/*",
      "timeout": 30
    }
  ]
}
```

**æ•ˆæœåˆ†æ**:
- **æ™®é€šç”¨æˆ·** è®¿é—® `https://files.example.com` æ—¶:
  - `timeout` ä¸º `1800` ç§’ (æ¥è‡ª mapping)ã€‚
  - `quality` ä¸º `0.2` (ä¸‹è½½é€Ÿåº¦è¢«é™åˆ¶)ã€‚
  - `maxThread` ä¸º `100` (æ¥è‡ª server)ã€‚
- **`vip_user`** è®¿é—® `https://api.example.com` æ—¶:
  - `timeout` ä¸º `120` ç§’ (æ¥è‡ª userï¼Œä¼˜å…ˆçº§æœ€é«˜)ã€‚
  - `quality` ä¸º `1.0` (é»˜è®¤å€¼)ã€‚
  - `maxThread` ä¸º `100` (æ¥è‡ª server)ã€‚

---

### ç¤ºä¾‹ 6: åŒå‘è®¤è¯ (mTLS)

æ­¤ç¤ºä¾‹å±•ç¤ºäº†å¦‚ä½•é…ç½®ä¸€ä¸ªéœ€è¦å®¢æˆ·ç«¯è¯ä¹¦çš„ APIã€‚

```json
{
  "servers": {
    "main": { "port": 8080, "cert": "auto" }
  },
  "p12s": {
    "api_cert": {
      "path": "./certs/my_api_client_cert.p12",
      "password": "cert_password"
    }
  },
  "mappings": [
    {
      "comment": "è®¿é—®éœ€è¦ mTLS çš„å†…éƒ¨ API",
      "from": "https://secure.internal.api/*",
      "to": "https://backend.internal.api/*",
      "p12": "api_cert"
    }
  ]
}
```

**æ•ˆæœ**:
å½“é€šè¿‡ä»£ç†è®¿é—® `https://secure.internal.api/some/path` æ—¶ï¼Œä»£ç†ä¼šåœ¨ TLS æ¡æ‰‹æœŸé—´å‘ `backend.internal.api` æœåŠ¡å™¨å‡ºç¤º `my_api_client_cert.p12` è¯ä¹¦ã€‚å¦‚æœåç«¯æœåŠ¡å™¨éªŒè¯æ­¤è¯ä¹¦ï¼Œè¿æ¥å°†æˆåŠŸå»ºç«‹ã€‚

---

### ç¤ºä¾‹ 7: NAT ç©¿é€ (Tunnels & Endpoints)

æ­¤åŠŸèƒ½å…è®¸ä½ åœ¨ NAT æˆ–é˜²ç«å¢™åçš„æœºå™¨ä¸Šè¿è¡Œä¸€ä¸ª `endpoint` å®¢æˆ·ç«¯ï¼Œå¹¶è®©ä¸»ä»£ç†æœåŠ¡å™¨é€šè¿‡ä¸€ä¸ªå®‰å…¨çš„ `tunnel` å°†è¯·æ±‚è½¬å‘ç»™å®ƒã€‚

**å·¥ä½œæµç¨‹**:

1. åœ¨ä¸»é…ç½®æ–‡ä»¶ä¸­å®šä¹‰ä¸€ä¸ª `tunnel`ï¼Œå¹¶æŒ‡å®šå“ªäº› `servers` ä½œä¸ºå…¥å£ã€‚
2. åœ¨è¿œç¨‹æœºå™¨ä¸Šå¯åŠ¨ `endpoint` å®¢æˆ·ç«¯ï¼Œå¹¶è¿æ¥åˆ°æŒ‡å®šçš„ `server` å…¥å£ã€‚
3. åœ¨ `mapping` è§„åˆ™ä¸­ï¼Œä½¿ç”¨ `endpoint` å­—æ®µæŒ‡å®šå°†è¯·æ±‚è·¯ç”±åˆ°å“ªä¸ª `endpoint`ã€‚

#### 1. æ–°çš„é¡¶å±‚é…ç½®: `tunnels`

`tunnels` æ˜¯ä¸€ä¸ªæ–°çš„é¡¶å±‚ `map`ï¼Œç”¨äºå®šä¹‰å‘½åçš„éš§é“ã€‚

```json
{
  "tunnels": {
    "home_lab": {
      "servers": ["public_proxy"],
      "password": "secure_tunnel_password"
    }
  }
}
```

- `servers` (å¿…éœ€): ä¸€ä¸ªå­—ç¬¦ä¸²æ•°ç»„ï¼Œå¼•ç”¨ `servers` é…ç½®ä¸­å®šä¹‰çš„æœåŠ¡å™¨åç§°ã€‚è¿™äº›æœåŠ¡å™¨å°†ç›‘å¬æ¥è‡ª `endpoint` å®¢æˆ·ç«¯çš„ WebSocket è¿æ¥ã€‚
- `password` (å¯é€‰): ä¸ºéš§é“æµé‡æä¾›ç«¯åˆ°ç«¯åŠ å¯†çš„å¯†ç ã€‚å¦‚æœæä¾›ï¼Œæ‰€æœ‰é€šè¿‡æ­¤éš§é“çš„æ•°æ®éƒ½å°†ä½¿ç”¨ AES-GCM åŠ å¯†ã€‚

#### 2. åœ¨è§„åˆ™ä¸­ä½¿ç”¨ `endpoint`

ä½ å¯ä»¥åœ¨ `mapping`, `user`, `group`, æˆ– `server` çº§åˆ«ä¸Šæ·»åŠ  `endpoint` å­—æ®µï¼Œä»¥æŒ‡å®šè¯·æ±‚åº”é€šè¿‡å“ªä¸ª `endpoint` å®¢æˆ·ç«¯æ‰§è¡Œã€‚

- `endpoint` (å¯é€‰): ä¸€ä¸ªå­—ç¬¦ä¸²æ•°ç»„ï¼ŒæŒ‡å®š `endpoint` å®¢æˆ·ç«¯çš„åç§°ã€‚å¦‚æœæä¾›äº†å¤šä¸ªåç§°ï¼Œä»£ç†å°†ä»å½“å‰åœ¨çº¿çš„ `endpoint` ä¸­éšæœºé€‰æ‹©ä¸€ä¸ªã€‚

#### 3. å¯åŠ¨ `endpoint` å®¢æˆ·ç«¯

`endpoint` æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„ç¨‹åºã€‚ä½ éœ€è¦åœ¨è¿œç¨‹æœºå™¨ä¸Šç¼–è¯‘å¹¶è¿è¡Œå®ƒã€‚

```bash
# ç¼–è¯‘ endpoint
go build -o endpoint.exe ./endpoint

# è¿è¡Œ endpoint
./endpoint.exe \
  -server="ws://your_proxy_domain:8080/.tunnel" \
  -name="home_lab_endpoint_1" \
  -tunnel="home_lab" \
  -password="secure_tunnel_password"
```

**å‘½ä»¤è¡Œå‚æ•°**:

- `-server`: ä¸»ä»£ç†æœåŠ¡å™¨çš„ WebSocket å…¥å£åœ°å€ã€‚è·¯å¾„å›ºå®šä¸º `/.tunnel`ã€‚
- `-name`: æ­¤ `endpoint` å®¢æˆ·ç«¯çš„å”¯ä¸€åç§°ã€‚
- `-tunnel`: æ­¤ `endpoint` æƒ³è¦åŠ å…¥çš„ `tunnel` åç§°ï¼ˆå¿…é¡»åœ¨ `config.json` ä¸­å·²å®šä¹‰ï¼‰ã€‚
- `-password`: ä¸ `tunnel` é…ç½®ä¸­åŒ¹é…çš„å¯†ç ã€‚

#### 4. å®Œæ•´é…ç½®ç¤ºä¾‹

```json
{
  "servers": {
    "public_proxy": { "port": 8080, "cert": "auto" }
  },
  "tunnels": {
    "home_lab": {
      "servers": ["public_proxy"],
      "password": "a_secure_password"
    }
  },
  "mappings": [
    {
      "comment": "å°†å¯¹å†…ç½‘æœåŠ¡çš„è¯·æ±‚è½¬å‘åˆ°å®¶åº­å®éªŒå®¤çš„ endpoint",
      "from": "https://internal.service.com/*",
      "to": "http://192.168.1.100:80/*",
      "endpoint": ["home_lab_endpoint_1", "home_lab_endpoint_2"]
    }
  ]
}
```

**æ•ˆæœ**:

1. `endpoint` å®¢æˆ·ç«¯ `home_lab_endpoint_1` å’Œ `home_lab_endpoint_2` å¯åŠ¨å¹¶è¿æ¥åˆ° `public_proxy` æœåŠ¡å™¨çš„ `ws://...:8080/.tunnel`ã€‚
2. å½“ä¸€ä¸ªå¤–éƒ¨è¯·æ±‚é€šè¿‡ `public_proxy` è®¿é—® `https://internal.service.com/some/path` æ—¶ï¼Œä»£ç†ä¼šåŒ¹é…åˆ°è¯¥è§„åˆ™ã€‚
3. ä»£ç†å‘ç°è§„åˆ™éœ€è¦ `endpoint`ï¼Œå®ƒä¼šé€‰æ‹©ä¸€ä¸ªå½“å‰åœ¨çº¿çš„ `endpoint` (ä¾‹å¦‚ `home_lab_endpoint_1`)ã€‚
4. è¯·æ±‚è¢«å®‰å…¨åœ°è½¬å‘åˆ° `home_lab_endpoint_1`ã€‚
5. `endpoint` å®¢æˆ·ç«¯åœ¨æœ¬åœ°ç½‘ç»œä¸­æ‰§è¡Œå¯¹ `http://192.168.1.100:80/some/path` çš„è¯·æ±‚ï¼Œå¹¶å°†å“åº”é€šè¿‡éš§é“å®‰å…¨åœ°ä¼ å›ã€‚

## ğŸ“„ è®¸å¯è¯

MIT License
